#0Y UTF-8

(PROGN (SETQ *PACKAGE* (SYSTEM::%FIND-PACKAGE "OPAL")))
(PROGN (SYSTEM::C-PROCLAIM '(SPECIAL WORK-CLIP-MASK)))
(PROGN (SYSTEM::C-PROCLAIM '(SPECIAL WORK-BBOX)))
(PROGN (SYSTEM::REMOVE-OLD-DEFINITIONS 'POINT-TO-RANK)
 (SYSTEM::%PUTD 'POINT-TO-RANK
  (SYSTEM::MAKE-MACRO
   (FUNCTION POINT-TO-RANK
    (LAMBDA (SYSTEM::<MACRO-FORM> &OPTIONAL SYSTEM::<ENV-ARG>)
     (DECLARE (CONS SYSTEM::<MACRO-FORM>)) (DECLARE (IGNORE SYSTEM::<ENV-ARG>))
     (IF (< (LENGTH SYSTEM::<MACRO-FORM>) 2.)
      (SYSTEM::MACRO-CALL-ERROR SYSTEM::<MACRO-FORM>)
      (LET* ((SCHEMA (CADR . #1=(SYSTEM::<MACRO-FORM>))) (ARGS (CDDR . #1#)))
       (BLOCK POINT-TO-RANK
        `(LET ((THE-SCHEMA ,SCHEMA))
          (KR-SEND THE-SCHEMA :POINT-TO-RANK THE-SCHEMA ,@ARGS))))))))))
(PROGN
 (SYSTEM::C-DEFUN 'SET-THINGS-SIZE
  (SYSTEM::LAMBDA-LIST-TO-SIGNATURE '(THING THING-BBOX))))
(PROGN
 (SYSTEM::C-DEFUN 'INITIALIZE-ITEM-BBOX
  (SYSTEM::LAMBDA-LIST-TO-SIGNATURE
   '(THING THING-BBOX BBOX-ARRAY DUMMY ITEM-ARRAY RANK &OPTIONAL RANK2))))
(PROGN
 (SYSTEM::C-DEFUN 'RECALCULATE-VIRTUAL-AGGREGATE-BBOXES
  (SYSTEM::LAMBDA-LIST-TO-SIGNATURE '(THING))))
(PROGN
 (SYSTEM::C-DEFUN 'INITIALIZE-METHOD-VIRTUAL-AGGREGATE
  (SYSTEM::LAMBDA-LIST-TO-SIGNATURE '(GOB))))
(PROGN
 (SYSTEM::C-DEFUN 'POINT-TO-RANK-METHOD-VIRTUAL-AGGREGATE
  (SYSTEM::LAMBDA-LIST-TO-SIGNATURE '(GOB X Y))))
(PROGN
 (SYSTEM::C-DEFUN 'POINT-TO-COMPONENT-METHOD-VIRTUAL-AGGREGATE
  (SYSTEM::LAMBDA-LIST-TO-SIGNATURE '(A-THING X Y &KEY (TYPE T)))))
(PROGN (SYSTEM::REMOVE-OLD-DEFINITIONS 'DO-IN-CLIP-RECT)
 (SYSTEM::%PUTD 'DO-IN-CLIP-RECT
  (SYSTEM::MAKE-MACRO
   (FUNCTION DO-IN-CLIP-RECT
    (LAMBDA (SYSTEM::<MACRO-FORM> &OPTIONAL SYSTEM::<ENV-ARG>)
     (DECLARE (CONS SYSTEM::<MACRO-FORM>)) (DECLARE (IGNORE SYSTEM::<ENV-ARG>))
     (IF (< (LENGTH SYSTEM::<MACRO-FORM>) 2.)
      (SYSTEM::MACRO-CALL-ERROR SYSTEM::<MACRO-FORM>)
      (LET*
       ((M (CAADR . #1=(SYSTEM::<MACRO-FORM>))) (N (CADADR . #1#))
        (AGG (CAR #2=(CDDADR . #1#))) (RECT (CADR #2#)) (BODY (CDDR . #1#)))
       (BLOCK DO-IN-CLIP-RECT
        `(LET*
          ((AGG* ,AGG) (P-TO-R (G-VALUE AGG* :POINT-TO-RANK)) (R* ,RECT)
           (ARRAY-SIZE* (G-VALUE AGG* :ARRAY-LENGTH))
           (MAX-X2* (1- (FIRST ARRAY-SIZE*)))
           (MAX-Y2* (1- (SECOND ARRAY-SIZE*))) (FIRST* (FIRST R*))
           (SECOND* (SECOND R*)))
          (MULTIPLE-VALUE-BIND (X1* Y1*) (FUNCALL P-TO-R AGG* FIRST* SECOND*)
           (MULTIPLE-VALUE-BIND (X2* Y2*)
            (FUNCALL P-TO-R AGG* (+ FIRST* (THIRD R*) -1.)
             (+ SECOND* (FOURTH R*) -1.))
            (SETQ X1* (IF X1* (MAX 0. X1*) 0.))
            (SETQ Y1* (IF Y1* (MAX 0. Y1*) 0.))
            (SETQ X2* (IF X2* (MIN X2* MAX-X2*) MAX-X2*))
            (SETQ Y2* (IF Y2* (MIN Y2* MAX-Y2*) MAX-Y2*))
            (WHEN (AND (<= X1* X2*) (<= Y1* Y2*))
             (DO ((,M X1* (1+ ,M))) ((> ,M X2*))
              (DO ((,N Y1* (1+ ,N))) ((> ,N Y2*)) ,@BODY))))))))))))))
(PROGN
 (SYSTEM::C-DEFUN 'MAKE-VIRTUAL-AGGREGATE-INVALID
  (SYSTEM::LAMBDA-LIST-TO-SIGNATURE '(AGG))))
(PROGN
 (SYSTEM::C-DEFUN 'UPDATE-METHOD-VIRTUAL-AGGREGATE
  (SYSTEM::LAMBDA-LIST-TO-SIGNATURE
   '(GOB UPDATE-INFO BBOX-1 BBOX-2 &OPTIONAL (TOTAL-P NIL)))))
(PROGN
 (SYSTEM::C-DEFUN 'ADD-ITEM-METHOD-VIRTUAL-AGGREGATE
  (SYSTEM::LAMBDA-LIST-TO-SIGNATURE '(GOB NEW-ITEM))))
(PROGN
 (SYSTEM::C-DEFUN 'CHANGE-ITEM-METHOD-VIRTUAL-AGGREGATE
  (SYSTEM::LAMBDA-LIST-TO-SIGNATURE '(GOB NEW-ITEM RANK &OPTIONAL RANK2))))
(PROGN
 (SYSTEM::C-DEFUN 'REMOVE-ITEM-METHOD-VIRTUAL-AGGREGATE
  (SYSTEM::LAMBDA-LIST-TO-SIGNATURE '(GOB RANK))))
(PROGN
 (SYSTEM::C-DEFUN 'DESTROY-ME-METHOD-VIRTUAL-AGGREGATE
  (SYSTEM::LAMBDA-LIST-TO-SIGNATURE '(GOB &OPTIONAL (TOP-LEVEL-P T)))))